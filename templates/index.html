<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>打卡系统</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" >
<style>
    /* 调整高度 */
    .add-job-container {
        height: 30px; /* 原高度减半，可根据需要调整 */
    }

    /* 缩短输入框 */
    .new-job-input {
        flex: 1 1 auto; /* 自适应宽度 */
        max-width: 150px; /* 控制最大宽度 */
    }

    /* 加宽按钮 */
    .add-job {
        flex: 0 1 100px; /* 固定按钮宽度 */
    }

     /* 限制 job 名称的宽度并显示省略号 */
    .job-name {
        display: inline-block;
        max-width: 20px; /* 设置显示宽度，根据需求调整 */
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        vertical-align: middle;
    }
</style>
</head>
<body>
<div class="container">
    <h1 class="my-4">打卡系统</h1>
    {% for project_name, data in projects.items() %}
    <div class="card mb-4">
        <div class="card-header">{{ project_name }}</div>
        <div class="card-body">
            <!-- 进度条 -->
            <div class="progress mb-3">
                <div class="progress-bar" role="progressbar" style="width: {{ (data.completed_dates|length / data.jobs|length) * 100 }}%;"
                     aria-valuenow="{{ (data.completed_dates|length / data.jobs|length) * 100 }}"
                     aria-valuemin="0"
                     aria-valuemax="100">
                    {{ (data.completed_dates|length / data.jobs|length) * 100 }}%
                </div>
            </div>

            <!-- 横向排列的 jobs -->
            <div class="d-flex flex-row overflow-auto">
                {% for date in data.jobs %}
                <div class="p-2 border border-secondary rounded me-2">
                    <form action="{{ url_for('update') }}" method="post" style="display: inline;">
                        <input type="hidden" name="date" value="{{ date }}">
                        <input type="hidden" name="project_name" value="{{ project_name }}">
                        <label>
                            <input type="checkbox" name="check" value="{{ date }}"
                                {% if date in data.completed_dates %}checked{% endif %}>
                            <span class="job-name">{{ date }}</span> <!-- job名称截断显示 -->
                        </label>
                        <!-- 更新图标 -->
                        <button type="submit" class="btn btn-sm btn-link p-0">
                            <i class="fas fa-sync-alt text-primary"></i>
                        </button>
                    </form>
                    <!-- 删除图标 -->
                    <button class="btn btn-sm btn-link p-0 delete-job" data-project="{{ project_name }}" data-job="{{ date }}">
                        <i class="fas fa-trash-alt text-danger"></i>
                    </button>
                </div>
                {% endfor %}
            </div>

            <!-- 添加新的 job -->
            <div class="mt-3 d-flex">
                <input type="text" class="form-control new-job-input" placeholder="添加新的任务" data-project="{{ project_name }}">
                <button class="btn btn-success ms-2 add-job" data-project="{{ project_name }}">添加任务</button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function() {
        // 初始化进度条上的百分比文本
        $('.progress-bar').each(function() {
            var percent = $(this).attr('aria-valuenow');
            $(this).text(Math.round(percent) + '%');
        });

        // 添加新的 job
        $('.add-job').on('click', function() {
            var projectName = $(this).data('project');
            var job = $(this).siblings('.new-job-input').val();

            if (job) {
                $.ajax({
                    type: 'POST',
                    url: '/add_job',
                    data: { project_name: projectName, job: job },
                    success: function(response) {
                        location.reload();  // 成功后刷新页面以显示新任务
                    }
                });
            }
        });

        // 删除 job
        $('.delete-job').on('click', function() {
            var projectName = $(this).data('project');
            var job = $(this).data('job');

            $.ajax({
                type: 'POST',
                url: '/delete_job',
                data: { project_name: projectName, job: job },
                success: function(response) {
                    location.reload();  // 成功后刷新页面以移除已删除的任务
                }
            });
        });

        // 处理表单提交后的进度条更新
        $('form').on('submit', function(event) {
            event.preventDefault();
            var form = $(this);
            $.ajax({
                type: 'POST',
                url: '/update',
                data: form.serialize(),
                success: function() {
                    location.reload(); // 重新加载页面以更新进度条
                }
            });
        });
    });
</script>
</body>
</html>
